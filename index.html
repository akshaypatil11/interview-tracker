<!doctype html>
<html lang="en" data-bs-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Interview Tracker</title>
  <!-- Bootstrap 5.3 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root{
      --brand: #4f46e5; /* indigo-600 */
    }
    body{min-height:100vh;}
    .navbar-brand .dot{color:var(--brand)}
    .badge-soft{background:rgba(79,70,229,.1); color:#4338ca;}
    .status-badge{font-weight:600}
    .status-Applied{background:#e7f1ff; color:#0b5ed7}
    .status-Online%20Assessment{background:#f8f0ff; color:#6f42c1}
    .status-Screening{background:#fff3cd; color:#7a5a00}
    .status-Technical{background:#e7f5ff; color:#055160}
    .status-HR{background:#f1f8e9; color:#2f6f00}
    .status-Offer{background:#e6ffed; color:#0a7d2a}
    .status-Rejected{background:#fde2e1; color:#b02a37}
    .status-On%20Hold{background:#e9ecef; color:#495057}

    .table thead th{user-select:none;}

    /* Kanban */
    .kanban{display:grid; grid-template-columns: repeat(auto-fit, minmax(260px,1fr)); gap:1rem}
    .kanban-column{background:var(--bs-body-bg); border:1px dashed var(--bs-border-color); border-radius:.75rem; padding:.75rem;}
    .kanban-header{display:flex; align-items:center; justify-content:space-between; margin-bottom:.5rem}
    .kanban-dropzone{min-height:120px}
    .kanban-card{background:var(--bs-tertiary-bg); border:1px solid var(--bs-border-color); border-radius:.75rem; padding:.75rem; margin-bottom:.5rem; cursor:grab}

    /* Compact form labels */
    .form-label{font-weight:600}

    /* Hide native file input */
    #importFile{display:none}

    /* Sticky toolbar */
    .toolbar{position:sticky; top:0; z-index:1020; background:var(--bs-body-bg); border-bottom:1px solid var(--bs-border-color)}

    .progress.progress-thin{height:.5rem}

    .empty-state{border:1px dashed var(--bs-border-color); border-radius:.75rem; padding:2rem; text-align:center}
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg border-bottom">
    <div class="container-fluid">
      <a class="navbar-brand fw-bold" href="#">
        <i class="bi bi-briefcase me-1 text-primary"></i>
        Interview<span class="dot">·</span>Tracker
      </a>
      <div class="d-flex align-items-center gap-2 ms-auto">
        <div class="input-group d-none d-md-flex">
          <span class="input-group-text bg-transparent"><i class="bi bi-search"></i></span>
          <input id="searchInput" class="form-control" placeholder="Search company, role, notes…" />
        </div>
        <button id="themeToggle" class="btn btn-outline-secondary" type="button" title="Toggle theme"><i class="bi bi-moon-stars"></i></button>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navColl" aria-controls="navColl" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
      </div>
      <div class="collapse navbar-collapse" id="navColl">
        <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
          <li class="nav-item"><a class="nav-link" href="#" data-view="list">List</a></li>
          <li class="nav-item"><a class="nav-link" href="#" data-view="kanban">Kanban</a></li>
          <li class="nav-item"><a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#aboutModal">About</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="toolbar py-2">
    <div class="container-fluid">
      <div class="d-flex flex-wrap gap-2 align-items-center">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#editModal">
          <i class="bi bi-plus-lg me-1"></i> Add Interview
        </button>
        <div class="vr"></div>
        <div class="d-flex flex-wrap gap-2 align-items-center">
          <select id="statusFilter" class="form-select form-select-sm" style="width:200px">
            <option value="">All statuses</option>
            <option>Applied</option>
            <option>Online Assessment</option>
            <option>Screening</option>
            <option>Technical</option>
            <option>HR</option>
            <option>Offer</option>
            <option>On Hold</option>
            <option>Rejected</option>
          </select>
          <select id="priorityFilter" class="form-select form-select-sm" style="width:160px">
            <option value="">All priorities</option>
            <option>High</option>
            <option>Medium</option>
            <option>Low</option>
          </select>
          <select id="modeFilter" class="form-select form-select-sm" style="width:160px">
            <option value="">Any mode</option>
            <option>Onsite</option>
            <option>Hybrid</option>
            <option>Remote</option>
          </select>
          <input id="dateFrom" type="date" class="form-control form-control-sm" style="width:160px" placeholder="From" />
          <input id="dateTo" type="date" class="form-control form-control-sm" style="width:160px" placeholder="To" />
          <button id="clearFilters" class="btn btn-sm btn-outline-secondary">Clear</button>
        </div>
        <div class="ms-auto d-flex gap-2">
          <button id="exportBtn" class="btn btn-sm btn-outline-primary"><i class="bi bi-download me-1"></i>Export</button>
          <label class="btn btn-sm btn-outline-secondary mb-0" for="importFile"><i class="bi bi-upload me-1"></i>Import</label>
          <input id="importFile" type="file" accept="application/json" />
        </div>
      </div>
    </div>
  </div>

  <main class="container-fluid py-3" id="viewList">
    <div id="tableWrap" class="table-responsive">
      <table class="table align-middle" id="interviewTable">
        <thead>
          <tr>
            <th data-sort="company">Company <i class="bi bi-arrow-down-up ms-1"></i></th>
            <th data-sort="role">Role</th>
            <th data-sort="location">Location</th>
            <th data-sort="status">Status</th>
            <th data-sort="stage">Stage</th>
            <th data-sort="appliedDate">Applied</th>
            <th data-sort="nextStep">Next Step</th>
            <th data-sort="priority">Priority</th>
            <th data-sort="updatedAt">Updated</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
    <div id="emptyState" class="empty-state d-none">
      <h5 class="mb-1">No interviews yet</h5>
      <p class="text-secondary mb-3">Click “Add Interview” to create your first record.</p>
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#editModal"><i class="bi bi-plus-lg me-1"></i> Add Interview</button>
    </div>
  </main>

  <section class="container-fluid py-3 d-none" id="viewKanban">
    <div class="kanban" id="kanbanBoard">
      <!-- Columns inserted via JS -->
    </div>
  </section>

  <!-- Edit/Add Modal -->
  <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <form class="modal-content needs-validation" novalidate id="editForm">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-pencil-square me-1"></i> <span id="modalTitle">Add Interview</span></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="id" />
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Company <span class="text-danger">*</span></label>
              <input id="company" class="form-control" required />
              <div class="invalid-feedback">Company is required.</div>
            </div>
            <div class="col-md-6">
              <label class="form-label">Role <span class="text-danger">*</span></label>
              <input id="role" class="form-control" required />
              <div class="invalid-feedback">Role is required.</div>
            </div>
            <div class="col-md-6">
              <label class="form-label">Status</label>
              <select id="status" class="form-select">
                <option>Applied</option>
                <option>Online Assessment</option>
                <option>Screening</option>
                <option>Technical</option>
                <option>HR</option>
                <option>Offer</option>
                <option>On Hold</option>
                <option>Rejected</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Stage (% complete)</label>
              <input id="stage" type="range" min="0" max="100" step="5" class="form-range"/>
            </div>
            <div class="col-md-4">
              <label class="form-label">Priority</label>
              <select id="priority" class="form-select">
                <option>Medium</option>
                <option>High</option>
                <option>Low</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Mode</label>
              <select id="mode" class="form-select">
                <option>Hybrid</option>
                <option>Onsite</option>
                <option>Remote</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Location</label>
              <input id="location" class="form-control" placeholder="City / Country" />
            </div>
            <div class="col-md-4">
              <label class="form-label">Applied Date</label>
              <input id="appliedDate" type="date" class="form-control" />
            </div>
            <div class="col-md-4">
              <label class="form-label">Next Step (due)</label>
              <input id="nextStep" type="date" class="form-control" />
            </div>
            <div class="col-md-4">
              <label class="form-label">CTC / Salary</label>
              <input id="ctc" class="form-control" placeholder="e.g., ₹20 LPA" />
            </div>
            <div class="col-md-6">
              <label class="form-label">Contact Name</label>
              <input id="contact" class="form-control" />
            </div>
            <div class="col-md-6">
              <label class="form-label">Contact Email / Phone</label>
              <input id="contactInfo" class="form-control" />
            </div>
            <div class="col-md-6">
              <label class="form-label">Source / Link</label>
              <input id="source" class="form-control" placeholder="Job post URL or source" />
            </div>
            <div class="col-md-6">
              <label class="form-label">Resume / Notes Link</label>
              <input id="links" class="form-control" placeholder="Drive/Notion link" />
            </div>
            <div class="col-12">
              <label class="form-label">Notes</label>
              <textarea id="notes" class="form-control" rows="4" placeholder="Key points, Q&As, feedback, to-dos…"></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- About Modal -->
  <div class="modal fade" id="aboutModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">About this app</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p class="mb-2">A single‑file, offline‑friendly tracker for your interview applications. Data is saved in your browser (localStorage). Use Export/Import to back up or move devices.</p>
          <ul>
            <li>Clean Bootstrap 5 UI with light/dark mode</li>
            <li>List & Kanban views, drag cards between stages</li>
            <li>Search, filters, sort by any column</li>
            <li>Add rich details: contacts, links, salary, notes</li>
          </ul>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" data-bs-dismiss="modal">Great!</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toasts -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1080">
    <div id="toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-body"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
  // --------- Utilities ---------
  const $ = (s, root=document) => root.querySelector(s);
  const $$ = (s, root=document) => Array.from(root.querySelectorAll(s));
  const storageKey = 'interviews_v1';
  const themeKey = 'theme_pref_v1';

  const STATUS = [
    'Applied','Online Assessment','Screening','Technical','HR','Offer','On Hold','Rejected'
  ];

  const statusOrder = Object.fromEntries(STATUS.map((s,i)=>[s,i]));

  function uid(){ return Date.now().toString(36)+Math.random().toString(36).slice(2,7); }

  function load(){
    try{ return JSON.parse(localStorage.getItem(storageKey)) || []; }catch{ return []; }
  }
  function save(data){ localStorage.setItem(storageKey, JSON.stringify(data)); }

  function toast(msg){
    const el = $('#toast');
    $('.toast-body', el).textContent = msg;
    bootstrap.Toast.getOrCreateInstance(el, {delay:2000}).show();
  }

  function fmtDate(d){ if(!d) return ''; const x = new Date(d); if(Number.isNaN(x)) return ''; return x.toLocaleDateString(); }

  // --------- State ---------
  let data = load();
  let sortKey = 'updatedAt';
  let sortDir = 'desc';
  let activeView = 'list';

  // --------- Rendering ---------
  function applyFilters(items){
    const q = $('#searchInput').value.trim().toLowerCase();
    const fStatus = $('#statusFilter').value;
    const fPriority = $('#priorityFilter').value;
    const fMode = $('#modeFilter').value;
    const from = $('#dateFrom').value ? new Date($('#dateFrom').value) : null;
    const to = $('#dateTo').value ? new Date($('#dateTo').value) : null;

    return items.filter(it=>{
      if(fStatus && it.status !== fStatus) return false;
      if(fPriority && it.priority !== fPriority) return false;
      if(fMode && it.mode !== fMode) return false;
      if(q){
        const hay = `${it.company} ${it.role} ${it.location||''} ${it.notes||''}`.toLowerCase();
        if(!hay.includes(q)) return false;
      }
      if(from){ const d = it.appliedDate ? new Date(it.appliedDate) : null; if(!d || d < from) return false; }
      if(to){ const d = it.appliedDate ? new Date(it.appliedDate) : null; if(!d || d > to) return false; }
      return true;
    });
  }

  function sortItems(items){
    const dir = sortDir === 'asc' ? 1 : -1;
    return items.sort((a,b)=>{
      let va = a[sortKey], vb = b[sortKey];
      if(sortKey === 'status'){ va = statusOrder[a.status] ?? 99; vb = statusOrder[b.status] ?? 99; }
      if(sortKey === 'stage'){ va = +a.stage||0; vb = +b.stage||0; }
      if(['appliedDate','nextStep','updatedAt'].includes(sortKey)){
        va = va ? new Date(va).getTime() : 0; vb = vb ? new Date(vb).getTime() : 0;
      }
      if(typeof va === 'string') va = va.toLowerCase();
      if(typeof vb === 'string') vb = vb.toLowerCase();
      if(va < vb) return -1*dir;
      if(va > vb) return 1*dir;
      return 0;
    });
  }

  function renderTable(){
    const items = sortItems(applyFilters([...data]));
    const tbody = $('#tableBody');
    tbody.innerHTML = '';

    if(items.length === 0){
      $('#tableWrap').classList.add('d-none');
      $('#emptyState').classList.remove('d-none');
      return;
    } else {
      $('#tableWrap').classList.remove('d-none');
      $('#emptyState').classList.add('d-none');
    }

    for(const it of items){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="fw-semibold">${it.company}</td>
        <td>${it.role||''}</td>
        <td>${it.location||''}</td>
        <td><span class="badge status-badge status-${encodeURIComponent(it.status)}">${it.status}</span></td>
        <td style="min-width:140px">
          <div class="d-flex align-items-center gap-2">
            <div class="progress progress-thin flex-grow-1" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="${it.stage||0}">
              <div class="progress-bar" style="width:${it.stage||0}%"></div>
            </div>
            <small class="text-secondary">${it.stage||0}%</small>
          </div>
        </td>
        <td>${fmtDate(it.appliedDate)}</td>
        <td>${fmtDate(it.nextStep)} ${it.nextStep && new Date(it.nextStep) < new Date() ? '<span class="badge text-bg-danger ms-1">Due</span>':''}</td>
        <td><span class="badge text-bg-${it.priority==='High'?'danger':it.priority==='Low'?'secondary':'warning'}">${it.priority||''}</span></td>
        <td>${fmtDate(it.updatedAt)}</td>
        <td>
          <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-secondary" data-action="view" title="View"><i class="bi bi-eye"></i></button>
            <button class="btn btn-outline-primary" data-action="edit" title="Edit"><i class="bi bi-pencil"></i></button>
            <button class="btn btn-outline-danger" data-action="delete" title="Delete"><i class="bi bi-trash"></i></button>
          </div>
        </td>`;
      tr.dataset.id = it.id;
      tbody.appendChild(tr);
    }
  }

  function renderKanban(){
    const board = $('#kanbanBoard');
    board.innerHTML = '';
    const byStatus = new Map(STATUS.map(s=>[s,[]]));
    for(const it of applyFilters([...data])){
      if(!byStatus.has(it.status)) byStatus.set(it.status, []);
      byStatus.get(it.status).push(it);
    }
    for(const s of STATUS){
      const col = document.createElement('div');
      col.className = 'kanban-column';
      col.innerHTML = `
        <div class="kanban-header">
          <div class="fw-semibold">${s}</div>
          <span class="badge rounded-pill text-bg-secondary">${(byStatus.get(s)||[]).length}</span>
        </div>
        <div class="kanban-dropzone" data-status="${s}"></div>`;
      board.appendChild(col);

      const zone = $('.kanban-dropzone', col);
      for(const it of sortItems(byStatus.get(s)||[])){
        const card = document.createElement('div');
        card.className = 'kanban-card';
        card.draggable = true;
        card.dataset.id = it.id;
        card.innerHTML = `
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="fw-semibold">${it.company}</div>
              <div class="small text-secondary">${it.role||''}</div>
            </div>
            <span class="badge text-bg-${it.priority==='High'?'danger':it.priority==='Low'?'secondary':'warning'}">${it.priority||''}</span>
          </div>
          <div class="mt-2">
            <div class="progress progress-thin"><div class="progress-bar" style="width:${it.stage||0}%"></div></div>
          </div>
          <div class="small mt-2 d-flex justify-content-between">
            <span><i class="bi bi-calendar-event"></i> ${fmtDate(it.nextStep)||'—'}</span>
            <button class="btn btn-sm btn-outline-secondary" data-action="edit"><i class="bi bi-pencil"></i></button>
          </div>`;
        zone.appendChild(card);
      }
    }

    // DnD handlers
    let draggedId = null;
    board.addEventListener('dragstart', e=>{
      const card = e.target.closest('.kanban-card');
      if(card){ draggedId = card.dataset.id; }
    });
    board.addEventListener('dragover', e=>{
      if(e.target.closest('.kanban-dropzone')) e.preventDefault();
    });
    board.addEventListener('drop', e=>{
      const zone = e.target.closest('.kanban-dropzone');
      if(zone && draggedId){
        const item = data.find(x=>x.id===draggedId);
        if(item){ item.status = zone.dataset.status; item.updatedAt = new Date().toISOString(); save(data); render(); toast('Status updated'); }
        draggedId = null;
      }
    });
  }

  function render(){
    if(activeView==='list'){ renderTable(); }
    else { renderKanban(); }
  }

  // --------- CRUD ---------
  function openForCreate(){
    $('#modalTitle').textContent = 'Add Interview';
    $('#editForm').reset();
    $('#id').value = '';
    $('#status').value = 'Applied';
    $('#priority').value = 'Medium';
    $('#mode').value = 'Hybrid';
  }

  function openForEdit(id){
    const it = data.find(x=>x.id===id);
    if(!it) return;
    $('#modalTitle').textContent = 'Edit Interview';
    $('#id').value = it.id;
    $('#company').value = it.company||'';
    $('#role').value = it.role||'';
    $('#status').value = it.status||'Applied';
    $('#stage').value = it.stage||0;
    $('#priority').value = it.priority||'Medium';
    $('#mode').value = it.mode||'Hybrid';
    $('#location').value = it.location||'';
    $('#appliedDate').value = it.appliedDate ? it.appliedDate.split('T')[0] : '';
    $('#nextStep').value = it.nextStep ? it.nextStep.split('T')[0] : '';
    $('#ctc').value = it.ctc||'';
    $('#contact').value = it.contact||'';
    $('#contactInfo').value = it.contactInfo||'';
    $('#source').value = it.source||'';
    $('#links').value = it.links||'';
    $('#notes').value = it.notes||'';
    const modal = new bootstrap.Modal($('#editModal')); modal.show();
  }

  function removeItem(id){
    const idx = data.findIndex(x=>x.id===id);
    if(idx>-1){ data.splice(idx,1); save(data); render(); toast('Deleted'); }
  }

  // --------- Events ---------
  // Sorting
  $('#interviewTable thead').addEventListener('click', e=>{
    const th = e.target.closest('th[data-sort]');
    if(!th) return;
    const key = th.dataset.sort;
    if(sortKey === key){ sortDir = sortDir==='asc'?'desc':'asc'; }
    else { sortKey = key; sortDir = 'asc'; }
    renderTable();
  });

  // Search & Filters
  $('#searchInput').addEventListener('input', ()=>render());
  $('#statusFilter').addEventListener('change', ()=>render());
  $('#priorityFilter').addEventListener('change', ()=>render());
  $('#modeFilter').addEventListener('change', ()=>render());
  $('#dateFrom').addEventListener('change', ()=>render());
  $('#dateTo').addEventListener('change', ()=>render());
  $('#clearFilters').addEventListener('click', ()=>{
    $('#statusFilter').value = '';
    $('#priorityFilter').value = '';
    $('#modeFilter').value = '';
    $('#dateFrom').value = '';
    $('#dateTo').value = '';
    $('#searchInput').value = '';
    render();
  });

  // View switch
  $$('a.nav-link[data-view]').forEach(a=>{
    a.addEventListener('click', (e)=>{
      e.preventDefault();
      activeView = a.dataset.view;
      $('#viewList').classList.toggle('d-none', activeView!=='list');
      $('#viewKanban').classList.toggle('d-none', activeView!=='kanban');
      render();
      $$('a.nav-link[data-view]').forEach(x=>x.classList.toggle('active', x===a));
    });
  });
  // default active
  $$('a.nav-link[data-view]')[0].classList.add('active');

  // Toolbar buttons
  $('#exportBtn').addEventListener('click', ()=>{
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'interviews-backup.json';
    a.click();
    URL.revokeObjectURL(a.href);
  });
  $('#importFile').addEventListener('change', (e)=>{
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      try{ const arr = JSON.parse(reader.result); if(Array.isArray(arr)){ data = arr; save(data); render(); toast('Imported successfully'); } else { throw new Error('Invalid format'); } }
      catch(err){ alert('Import failed: '+err.message); }
    };
    reader.readAsText(file);
    e.target.value = '';
  });

  // Table actions
  $('#tableBody').addEventListener('click', (e)=>{
    const btn = e.target.closest('button[data-action]');
    if(!btn) return;
    const id = e.target.closest('tr').dataset.id;
    const action = btn.dataset.action;
    if(action==='edit'){ openForEdit(id); }
    if(action==='delete'){
      if(confirm('Delete this record?')) removeItem(id);
    }
    if(action==='view'){
      const it = data.find(x=>x.id===id); if(!it) return;
      const details = `Company: ${it.company}\nRole: ${it.role}\nStatus: ${it.status}\nPriority: ${it.priority}\nApplied: ${fmtDate(it.appliedDate)}\nNext: ${fmtDate(it.nextStep)}\nLocation: ${it.location||''}\nMode: ${it.mode||''}\nCTC: ${it.ctc||''}\nSource: ${it.source||''}\nLinks: ${it.links||''}\nContact: ${it.contact||''} (${it.contactInfo||''})\n\nNotes:\n${it.notes||''}`;
      alert(details);
    }
  });

  // Modal open
  $('#editModal').addEventListener('show.bs.modal', (e)=>{
    if(!$('#id').value) openForCreate();
  });

  // Save form
  $('#editForm').addEventListener('submit', (e)=>{
    e.preventDefault();
    e.stopPropagation();
    const form = e.currentTarget;
    form.classList.add('was-validated');
    if(!form.checkValidity()) return;

    const payload = {
      id: $('#id').value || uid(),
      company: $('#company').value.trim(),
      role: $('#role').value.trim(),
      status: $('#status').value,
      stage: +$('#stage').value || 0,
      priority: $('#priority').value,
      mode: $('#mode').value,
      location: $('#location').value.trim(),
      appliedDate: $('#appliedDate').value ? new Date($('#appliedDate').value).toISOString() : '',
      nextStep: $('#nextStep').value ? new Date($('#nextStep').value).toISOString() : '',
      ctc: $('#ctc').value.trim(),
      contact: $('#contact').value.trim(),
      contactInfo: $('#contactInfo').value.trim(),
      source: $('#source').value.trim(),
      links: $('#links').value.trim(),
      notes: $('#notes').value.trim(),
      updatedAt: new Date().toISOString()
    };

    const idx = data.findIndex(x=>x.id===payload.id);
    if(idx>-1){ data[idx] = {...data[idx], ...payload}; toast('Updated'); }
    else { data.unshift(payload); toast('Added'); }
    save(data);
    render();
    bootstrap.Modal.getInstance($('#editModal')).hide();
    form.reset();
    form.classList.remove('was-validated');
  });

  // Theme toggle
  function setTheme(mode){
    document.documentElement.setAttribute('data-bs-theme', mode);
    localStorage.setItem(themeKey, mode);
    $('#themeToggle').innerHTML = mode==='dark' ? '<i class="bi bi-brightness-high"></i>' : '<i class="bi bi-moon-stars"></i>';
  }
  $('#themeToggle').addEventListener('click', ()=>{
    const cur = document.documentElement.getAttribute('data-bs-theme')||'light';
    setTheme(cur==='light'?'dark':'light');
  });
  (function initTheme(){ setTheme(localStorage.getItem(themeKey)||'light'); })();

  // Seed sample data on first run
  if(data.length===0){
    data = [
      {id:uid(), company:'Acme Corp', role:'Java Developer', status:'Applied', stage:10, priority:'High', mode:'Hybrid', location:'Bengaluru', appliedDate:new Date().toISOString(), nextStep:'', ctc:'₹18 LPA', contact:'Priya S', contactInfo:'priya@acme.com', source:'LinkedIn', links:'', notes:'Referred by Anil.', updatedAt:new Date().toISOString()},
      {id:uid(), company:'ByteWorks', role:'Data Engineer', status:'Screening', stage:40, priority:'Medium', mode:'Remote', location:'Pune', appliedDate:new Date(Date.now()-86400000*7).toISOString(), nextStep:new Date(Date.now()+86400000*2).toISOString(), ctc:'₹22 LPA', contact:'Rahul M', contactInfo:'', source:'Company site', links:'', notes:'Take-home due by Friday.', updatedAt:new Date().toISOString()},
      {id:uid(), company:'Nimbus Labs', role:'Spring Boot Dev', status:'Technical', stage:70, priority:'High', mode:'Onsite', location:'Hyderabad', appliedDate:new Date(Date.now()-86400000*20).toISOString(), nextStep:new Date(Date.now()+86400000*5).toISOString(), ctc:'₹20 LPA', contact:'HR – Ritu', contactInfo:'', source:'Recruiter', links:'', notes:'Prepare for system design.', updatedAt:new Date().toISOString()}
    ];
    save(data);
  }

  // Init
  document.addEventListener('DOMContentLoaded', ()=>{
    render();
    // Open create modal from button
    $$('[data-bs-target="#editModal"]').forEach(btn=>btn.addEventListener('click', openForCreate));
  });
  </script>
</body>
</html>
